2025-04-25 22:15:40,949 - INFO - [DetailedDebug] - Starting detailed order flow debug script
2025-04-25 22:15:40,949 - INFO - [DetailedDebug] - ================================================
2025-04-25 22:15:40,949 - INFO - [DetailedDebug] - === Starting Detailed Order-Fill Flow Debug ===
2025-04-25 22:15:40,949 - INFO - [DetailedDebug] - ================================================
2025-04-25 22:15:40,949 - INFO - [DetailedDebug] - STEP 1: Inspecting key functions
2025-04-25 22:15:40,949 - INFO - [DetailedDebug] - Inspecting create_fill_event function...
2025-04-25 22:15:40,949 - INFO - [DetailedDebug] - Source for create_fill_event:
def create_fill_event(symbol, direction, quantity, price, 
                     commission=0.0, timestamp=None, order_id=None):
    """Create a standardized fill event."""
    # Create the event
    fill = FillEvent(symbol, direction, quantity, price, 
                    commission, timestamp)
    
    # CRITICAL: Add order_id to the data dictionary
    if order_id is not None:
        # Ensure data is a dictionary
        if not hasattr(fill, 'data'):
            fill.data = {}
        
        # Set the order_id
        fill.data['order_id'] = order_id
        
        # Debug log to verify
        import logging
        logging.getLogger(__name__).debug(f"Added order_id to fill: {order_id}")
    
    return fill

2025-04-25 22:15:40,949 - INFO - [DetailedDebug] - Signature for create_fill_event: (symbol, direction, quantity, price, commission=0.0, timestamp=None, order_id=None)
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - STEP 2: Creating system components
2025-04-25 22:15:40,950 - DEBUG - [src.core.events.event_bus] - Registered handler for ORDER
2025-04-25 22:15:40,950 - DEBUG - [src.core.events.event_bus] - Registered handler for ORDER
2025-04-25 22:15:40,950 - DEBUG - [src.core.events.event_bus] - Registered handler for FILL
2025-04-25 22:15:40,950 - DEBUG - [src.core.events.event_bus] - Registered handler for ORDER
2025-04-25 22:15:40,950 - DEBUG - [src.core.events.event_bus] - Registered handler for FILL
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - STEP 3: Instrumenting broker's process_order method
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - STEP 4: Instrumenting order manager methods
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - STEP 5: Direct test with fixed order ID
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Generated test order ID: 81ff862e-27db-47b3-bec8-845832a5f5ba
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Added order_id to order event data: 81ff862e-27db-47b3-bec8-845832a5f5ba
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Processing order DIRECTLY through broker...
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - >>> BROKER.process_order entry point
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - --- Input Order Event Details ---
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Event Type: ORDER
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Event ID: 092b6087-3b5c-4cad-8388-57adbcee42f9
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-25 22:15:40.950216
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Event Data: {"symbol": "AAPL", "order_type": "MARKET", "direction": "BUY", "quantity": 100, "price": 150.0, "order_id": "81ff862e-27db-47b3-bec8-845832a5f5ba"}
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Symbol: AAPL
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Direction: BUY
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Quantity: 100
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Price: 150.0
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Extracted order_id from event data: 81ff862e-27db-47b3-bec8-845832a5f5ba
2025-04-25 22:15:40,950 - DEBUG - [src.core.events.event_utils] - Added order_id to fill: 81ff862e-27db-47b3-bec8-845832a5f5ba
2025-04-25 22:15:40,950 - INFO - [src.execution.broker.broker_simulator] - Broker processed order: BUY 100 AAPL @ 150.00
2025-04-25 22:15:40,950 - INFO - [src.execution.broker.broker_simulator] - Fill event created with order_id: 81ff862e-27db-47b3-bec8-845832a5f5ba
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - --- Output Fill Event Details ---
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Event Type: FILL
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Event ID: 8110c534-a92b-4b6b-836c-b09a456ae593
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-25 22:15:40.950216
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Event Data: {"symbol": "AAPL", "direction": "BUY", "quantity": 100, "price": 150.0, "commission": 0.0, "order_id": "81ff862e-27db-47b3-bec8-845832a5f5ba"}
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Symbol: AAPL
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Direction: BUY
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Quantity: 100
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Price: 150.0
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Fill event contains order_id: 81ff862e-27db-47b3-bec8-845832a5f5ba
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - <<< BROKER.process_order exit point
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Broker returned a fill event
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Fill contains order_id: 81ff862e-27db-47b3-bec8-845832a5f5ba
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - ✓ Original order ID matches fill order ID in direct test!
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - STEP 6: Full event flow test
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Generated flow test order ID: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Added order_id to flow order event data: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:40,950 - INFO - [DetailedDebug] - Emitting order event through event bus...
2025-04-25 22:15:40,950 - DEBUG - [src.core.events.event_bus] - Emitting ORDER event (ID: ef4fd072-cf77-45f5-b8fc-9423ef014dc4)
2025-04-25 22:15:40,950 - DEBUG - [src.execution.broker.broker_simulator] - Broker extracted order_id: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:40,950 - DEBUG - [src.execution.order_manager] - Order stored with ID: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:40,950 - DEBUG - [src.core.events.event_bus] - Emitting PORTFOLIO event (ID: 9528d104-d4e3-4c5a-a38c-8611e080182c)
2025-04-25 22:15:40,950 - INFO - [src.execution.order_manager] - Created order: Order(e5136fd2-84c5-404d-8d6a-9fc75a52c55e, MSFT, BUY, 50, PENDING)
2025-04-25 22:15:40,950 - DEBUG - [src.execution.order_manager] - Order e5136fd2-84c5-404d-8d6a-9fc75a52c55e already being tracked
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - >>> BROKER.process_order entry point
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - --- Input Order Event Details ---
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Event Type: ORDER
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Event ID: ef4fd072-cf77-45f5-b8fc-9423ef014dc4
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-25 22:15:40.950715
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Event Data: {"symbol": "MSFT", "order_type": "MARKET", "direction": "BUY", "quantity": 50, "price": 250.0, "order_id": "e5136fd2-84c5-404d-8d6a-9fc75a52c55e"}
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Symbol: MSFT
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Direction: BUY
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Quantity: 50
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Price: 250.0
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Extracted order_id from event data: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:40,963 - DEBUG - [src.core.events.event_utils] - Added order_id to fill: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:40,963 - INFO - [src.execution.broker.broker_simulator] - Broker processed order: BUY 50 MSFT @ 250.00
2025-04-25 22:15:40,963 - INFO - [src.execution.broker.broker_simulator] - Fill event created with order_id: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - --- Output Fill Event Details ---
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Event Type: FILL
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Event ID: 48a20b27-aac7-4e51-9771-14224e193afd
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-25 22:15:40.950715
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Event Data: {"symbol": "MSFT", "direction": "BUY", "quantity": 50, "price": 250.0, "commission": 0.0, "order_id": "e5136fd2-84c5-404d-8d6a-9fc75a52c55e"}
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Symbol: MSFT
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Direction: BUY
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Quantity: 50
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Price: 250.0
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - Fill event contains order_id: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:40,963 - INFO - [DetailedDebug] - <<< BROKER.process_order exit point
2025-04-25 22:15:40,963 - INFO - [src.execution.broker.broker_simulator] - Broker emitting fill event for MSFT
2025-04-25 22:15:40,963 - DEBUG - [src.core.events.event_bus] - Emitting FILL event (ID: 48a20b27-aac7-4e51-9771-14224e193afd)
2025-04-25 22:15:40,964 - DEBUG - [src.execution.order_manager] - Found order_id in fill event: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:40,964 - DEBUG - [src.execution.order_manager] - Found matching order: Order(e5136fd2-84c5-404d-8d6a-9fc75a52c55e, MSFT, BUY, 50, PENDING)
2025-04-25 22:15:40,964 - DEBUG - [src.core.events.event_bus] - Emitting PORTFOLIO event (ID: 34e5f442-af30-4ec2-9931-79b701585aa2)
2025-04-25 22:15:40,964 - INFO - [src.execution.order_manager] - Updated order with fill: Order(e5136fd2-84c5-404d-8d6a-9fc75a52c55e, MSFT, BUY, 50, FILLED)
2025-04-25 22:15:40,964 - DEBUG - [src.execution.order_manager] - Fill 48a20b27-aac7-4e51-9771-14224e193afd already processed, skipping
2025-04-25 22:15:41,051 - INFO - [DetailedDebug] - STEP 7: Direct test of order manager
2025-04-25 22:15:41,051 - INFO - [DetailedDebug] - Generated direct order ID: ef780004-5a56-4cd6-9874-b79f8a51261c
2025-04-25 22:15:41,051 - INFO - [DetailedDebug] - Manually added order ef780004-5a56-4cd6-9874-b79f8a51261c to order manager
2025-04-25 22:15:41,051 - INFO - [DetailedDebug] - Added order_id to direct fill event data: ef780004-5a56-4cd6-9874-b79f8a51261c
2025-04-25 22:15:41,051 - INFO - [DetailedDebug] - Calling on_fill method directly...
2025-04-25 22:15:41,051 - INFO - [DetailedDebug] - >>> ORDER_MANAGER.on_fill entry point
2025-04-25 22:15:41,051 - INFO - [DetailedDebug] - --- Input Fill Event Details ---
2025-04-25 22:15:41,051 - INFO - [DetailedDebug] - Event Type: FILL
2025-04-25 22:15:41,051 - INFO - [DetailedDebug] - Event ID: 620fd2dc-9b66-463b-afee-b1522dec739d
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-25 22:15:41.051889
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Event Data: {"symbol": "GOOGL", "direction": "BUY", "quantity": 25, "price": 100.0, "commission": 0.0, "order_id": "ef780004-5a56-4cd6-9874-b79f8a51261c"}
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Symbol: GOOGL
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Direction: BUY
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Quantity: 25
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Price: 100.0
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Found order_id in fill event data: ef780004-5a56-4cd6-9874-b79f8a51261c
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Orders in manager before fill: ['e5136fd2-84c5-404d-8d6a-9fc75a52c55e', 'ef780004-5a56-4cd6-9874-b79f8a51261c']
2025-04-25 22:15:41,052 - DEBUG - [src.execution.order_manager] - Found order_id in fill event: ef780004-5a56-4cd6-9874-b79f8a51261c
2025-04-25 22:15:41,052 - DEBUG - [src.execution.order_manager] - Found matching order: Order(ef780004-5a56-4cd6-9874-b79f8a51261c, GOOGL, BUY, 25, CREATED)
2025-04-25 22:15:41,052 - DEBUG - [src.core.events.event_bus] - Emitting PORTFOLIO event (ID: ddb546de-7ca2-4fb2-aa43-c9048fe87a5c)
2025-04-25 22:15:41,052 - INFO - [src.execution.order_manager] - Updated order with fill: Order(ef780004-5a56-4cd6-9874-b79f8a51261c, GOOGL, BUY, 25, FILLED)
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - on_fill completed successfully
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - <<< ORDER_MANAGER.on_fill exit point
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - STEP 8: Analyzing results
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Final orders in manager: ['e5136fd2-84c5-404d-8d6a-9fc75a52c55e', 'ef780004-5a56-4cd6-9874-b79f8a51261c']
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - All tracked IDs:
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] -   original_order_id: 81ff862e-27db-47b3-bec8-845832a5f5ba
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] -   broker_extracted_order_id: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] -   broker_fill_order_id: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] -   direct_fill_order_id: 81ff862e-27db-47b3-bec8-845832a5f5ba
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] -   flow_order_id: e5136fd2-84c5-404d-8d6a-9fc75a52c55e
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] -   direct_order_id: ef780004-5a56-4cd6-9874-b79f8a51261c
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] -   manager_received_fill_order_id: ef780004-5a56-4cd6-9874-b79f8a51261c
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - ✓ Direct test: Original order ID matches fill order ID
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - === Detailed Order-Fill Flow Debug Complete ===
2025-04-25 22:15:41,052 - INFO - [DetailedDebug] - Debug script completed successfully
