2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - Starting detailed order flow debug script
2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - ================================================
2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - === Starting Detailed Order-Fill Flow Debug ===
2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - ================================================
2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - STEP 1: Inspecting key functions
2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - Inspecting create_fill_event function...
2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - Source for create_fill_event:
def create_fill_event(symbol, direction, quantity, price, 
                     commission=0.0, timestamp=None, order_id=None):
    """Create a standardized fill event."""
    # Create the event
    fill = FillEvent(symbol, direction, quantity, price, 
                    commission, timestamp)
    
    # CRITICAL: Add order_id to the data dictionary
    if order_id is not None:
        # Ensure data is a dictionary
        if not hasattr(fill, 'data'):
            fill.data = {}
        
        # Set the order_id
        fill.data['order_id'] = order_id
        
        # Debug log to verify
        import logging
        logging.getLogger(__name__).debug(f"Added order_id to fill: {order_id}")
    
    return fill

2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - Signature for create_fill_event: (symbol, direction, quantity, price, commission=0.0, timestamp=None, order_id=None)
2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - STEP 2: Creating system components
2025-04-24 23:19:25,493 - DEBUG - [src.core.events.event_bus] - Registered handler for ORDER
2025-04-24 23:19:25,493 - DEBUG - [src.core.events.event_bus] - Registered handler for ORDER
2025-04-24 23:19:25,493 - DEBUG - [src.core.events.event_bus] - Registered handler for FILL
2025-04-24 23:19:25,493 - DEBUG - [src.core.events.event_bus] - Registered handler for ORDER
2025-04-24 23:19:25,493 - DEBUG - [src.core.events.event_bus] - Registered handler for FILL
2025-04-24 23:19:25,493 - INFO - [DetailedDebug] - STEP 3: Instrumenting broker's process_order method
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - STEP 4: Instrumenting order manager methods
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - STEP 5: Direct test with fixed order ID
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Generated test order ID: b1f26244-4cbd-40cb-b68a-01c8018d1c2a
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Added order_id to order event data: b1f26244-4cbd-40cb-b68a-01c8018d1c2a
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Processing order DIRECTLY through broker...
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - >>> BROKER.process_order entry point
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - --- Input Order Event Details ---
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Type: ORDER
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event ID: 5fb001bd-4ad5-406a-8a4b-c552495adc80
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-24 23:19:25.494063
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Data: {"symbol": "AAPL", "order_type": "MARKET", "direction": "BUY", "quantity": 100, "price": 150.0, "order_id": "b1f26244-4cbd-40cb-b68a-01c8018d1c2a"}
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Symbol: AAPL
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Direction: BUY
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Quantity: 100
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Price: 150.0
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Extracted order_id from event data: b1f26244-4cbd-40cb-b68a-01c8018d1c2a
2025-04-24 23:19:25,494 - DEBUG - [src.execution.broker.broker_simulator] - Broker extracted order_id: b1f26244-4cbd-40cb-b68a-01c8018d1c2a
2025-04-24 23:19:25,494 - DEBUG - [src.core.events.event_utils] - Added order_id to fill: b1f26244-4cbd-40cb-b68a-01c8018d1c2a
2025-04-24 23:19:25,494 - INFO - [src.execution.broker.broker_simulator] - Broker processed order: BUY 100 AAPL @ 150.00
2025-04-24 23:19:25,494 - INFO - [src.execution.broker.broker_simulator] - Broker emitting fill event for AAPL
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - --- Output Fill Event Details ---
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Type: FILL
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event ID: afae8468-00e1-4293-b1f6-d135a0f21f45
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-24 23:19:25.494063
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Data: {"symbol": "AAPL", "direction": "BUY", "quantity": 100, "price": 150.0, "commission": 0.0, "order_id": "b1f26244-4cbd-40cb-b68a-01c8018d1c2a"}
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Symbol: AAPL
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Direction: BUY
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Quantity: 100
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Price: 150.0
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Fill event contains order_id: b1f26244-4cbd-40cb-b68a-01c8018d1c2a
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - <<< BROKER.process_order exit point
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Broker returned a fill event
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Fill contains order_id: b1f26244-4cbd-40cb-b68a-01c8018d1c2a
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - âœ“ Original order ID matches fill order ID in direct test!
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - STEP 6: Full event flow test
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Generated flow test order ID: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Added order_id to flow order event data: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Emitting order event through event bus...
2025-04-24 23:19:25,494 - DEBUG - [src.core.events.event_bus] - Emitting ORDER event (ID: ec01df59-db7c-43d5-84f6-0bb142b9a93a)
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - >>> BROKER.process_order entry point
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - --- Input Order Event Details ---
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Type: ORDER
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event ID: ec01df59-db7c-43d5-84f6-0bb142b9a93a
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-24 23:19:25.494580
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Data: {"symbol": "MSFT", "order_type": "MARKET", "direction": "BUY", "quantity": 50, "price": 250.0, "order_id": "59f83693-c703-4010-9776-aa551d38d6a8"}
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Symbol: MSFT
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Direction: BUY
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Quantity: 50
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Price: 250.0
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Extracted order_id from event data: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,494 - DEBUG - [src.execution.broker.broker_simulator] - Broker extracted order_id: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,494 - DEBUG - [src.core.events.event_utils] - Added order_id to fill: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,494 - INFO - [src.execution.broker.broker_simulator] - Broker processed order: BUY 50 MSFT @ 250.00
2025-04-24 23:19:25,494 - INFO - [src.execution.broker.broker_simulator] - Broker emitting fill event for MSFT
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - --- Output Fill Event Details ---
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Type: FILL
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event ID: 3b37eee0-487c-4784-a61c-9a94fc378188
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-24 23:19:25.494580
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Event Data: {"symbol": "MSFT", "direction": "BUY", "quantity": 50, "price": 250.0, "commission": 0.0, "order_id": "59f83693-c703-4010-9776-aa551d38d6a8"}
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Symbol: MSFT
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Direction: BUY
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Quantity: 50
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Price: 250.0
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - Fill event contains order_id: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,494 - INFO - [DetailedDebug] - <<< BROKER.process_order exit point
2025-04-24 23:19:25,495 - DEBUG - [src.core.events.event_bus] - Emitting FILL event (ID: 3b37eee0-487c-4784-a61c-9a94fc378188)
2025-04-24 23:19:25,495 - DEBUG - [src.execution.order_manager] - Found order_id in fill event: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,495 - ERROR - [src.execution.order_manager] - Order 59f83693-c703-4010-9776-aa551d38d6a8 not found in order manager
2025-04-24 23:19:25,495 - DEBUG - [src.execution.order_manager] - Found order_id in fill event: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,495 - ERROR - [src.execution.order_manager] - Order 59f83693-c703-4010-9776-aa551d38d6a8 not found in order manager
2025-04-24 23:19:25,495 - DEBUG - [src.execution.order_manager] - Order stored with ID: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,495 - DEBUG - [src.core.events.event_bus] - Emitting PORTFOLIO event (ID: aa84ce61-db99-42a5-a077-20b4c2e9f0ec)
2025-04-24 23:19:25,495 - INFO - [src.execution.order_manager] - Created order: Order(59f83693-c703-4010-9776-aa551d38d6a8, MSFT, BUY, 50, PENDING)
2025-04-24 23:19:25,495 - DEBUG - [src.execution.order_manager] - Order 59f83693-c703-4010-9776-aa551d38d6a8 already being tracked
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - STEP 7: Direct test of order manager
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Generated direct order ID: 214fab14-1483-4462-912e-d26ff675ac74
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Manually added order 214fab14-1483-4462-912e-d26ff675ac74 to order manager
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Added order_id to direct fill event data: 214fab14-1483-4462-912e-d26ff675ac74
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Calling on_fill method directly...
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - >>> ORDER_MANAGER.on_fill entry point
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - --- Input Fill Event Details ---
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Event Type: FILL
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Event ID: 0df823f6-6611-4549-b957-e05a992bf423
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Event Timestamp: 2025-04-24 23:19:25.600420
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Event Data: {"symbol": "GOOGL", "direction": "BUY", "quantity": 25, "price": 100.0, "commission": 0.0, "order_id": "214fab14-1483-4462-912e-d26ff675ac74"}
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Symbol: GOOGL
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Direction: BUY
2025-04-24 23:19:25,600 - INFO - [DetailedDebug] - Quantity: 25
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - Price: 100.0
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - ----------------------------------------
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - Found order_id in fill event data: 214fab14-1483-4462-912e-d26ff675ac74
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - Orders in manager before fill: ['59f83693-c703-4010-9776-aa551d38d6a8', '214fab14-1483-4462-912e-d26ff675ac74']
2025-04-24 23:19:25,601 - DEBUG - [src.execution.order_manager] - Found order_id in fill event: 214fab14-1483-4462-912e-d26ff675ac74
2025-04-24 23:19:25,601 - DEBUG - [src.execution.order_manager] - Found matching order: Order(214fab14-1483-4462-912e-d26ff675ac74, GOOGL, BUY, 25, CREATED)
2025-04-24 23:19:25,601 - DEBUG - [src.core.events.event_bus] - Emitting PORTFOLIO event (ID: 8af05aa8-e765-43c2-ad0c-7b166c9bc22c)
2025-04-24 23:19:25,601 - INFO - [src.execution.order_manager] - Updated order with fill: Order(214fab14-1483-4462-912e-d26ff675ac74, GOOGL, BUY, 25, FILLED)
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - on_fill completed successfully
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - <<< ORDER_MANAGER.on_fill exit point
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - STEP 8: Analyzing results
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - Final orders in manager: ['59f83693-c703-4010-9776-aa551d38d6a8', '214fab14-1483-4462-912e-d26ff675ac74']
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - All tracked IDs:
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] -   original_order_id: b1f26244-4cbd-40cb-b68a-01c8018d1c2a
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] -   broker_extracted_order_id: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] -   broker_fill_order_id: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] -   direct_fill_order_id: b1f26244-4cbd-40cb-b68a-01c8018d1c2a
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] -   flow_order_id: 59f83693-c703-4010-9776-aa551d38d6a8
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] -   direct_order_id: 214fab14-1483-4462-912e-d26ff675ac74
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] -   manager_received_fill_order_id: 214fab14-1483-4462-912e-d26ff675ac74
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - âœ“ Direct test: Original order ID matches fill order ID
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - === Detailed Order-Fill Flow Debug Complete ===
2025-04-24 23:19:25,601 - INFO - [DetailedDebug] - Debug script completed successfully
